<html>
<head>
    <script src="https://cdn.firebase.com/v0/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://www.firebase.com/css/example.css">
</head>

<body class="beerpong-body">
    <div>
        <canvas id="canvas0" width="300" height="600"></canvas>
    </div>
    <input type="button" id="restartButton" value="Restart Game" class="hide" />
    <div id="gameInProgress">Game is in progress.  You will automatically join if either player leaves.</div>


<script>

    var canvas = $("#canvas0").get(0);
    if (!canvas || !canvas.getContext || !canvas.getContext('2d'))
        alert("You must use a browser that supports HTML5 Canvas to run this demo.");

    function start() {
        var beerPongRef = new Firebase('https://beer-pong.firebaseio.com/');
        var beerPongController = new BeerPong.Controller(beerPongRef);

        beerPongRef.auth("iKCCsctxphzcK4mkO99UHfz3RWOWqeNhCUlU55BH", function(error) {
            if(error) {
                console.log("Login Failed!", error);
            } else {
                console.log("Login Succeeded!");
            }
        });
    }

    var BeerPong = { };

    BeerPong.BOARD[0] = "1111111111";
    BeerPong.BOARD[1] = "1111111111";

    // BOARD
    BeerPong.Board = function (canvas, playerRef) {
        this.context = canvas.getContext('2d');
        this.playerRef = playerRef;
        this.snapshot = null;
        this.isMyTurn = false;

        // Listen for changes to our board.
        var self = this;
        playerRef.on('value', function(snapshot) {
            self.snapshot = snapshot;
            self.draw();
        });
    };

    BeerPong.Board.prototype.draw = function () {
        this.context.clearRect(0, 0, BeerPong.BOARD_WIDTH_PIXELS, BeerPong.BOARD_HEIGHT_PIXELS);

        // Iterate over columns / rows in board data and draw each non-empty block.
        for (var x = 0; x < BeerPong.BOARD_WIDTH; x++) {
            for (var y = 0; y < BeerPong.BOARD_HEIGHT; y++) {
                var colorValue = this.getBlockVal(x, y);
                if (colorValue != ' ') {
                    // Calculate block position and draw a correctly-colored square.
                    var left = x * BeerPong.BLOCK_SIZE_PIXELS;
                    var top = y * BeerPong.BLOCK_SIZE_PIXELS;
                    this.context.fillStyle = BeerPong.BLOCK_COLORS[colorValue];
                    this.context.fillRect(left, top, BeerPong.BLOCK_SIZE_PIXELS, BeerPong.BLOCK_SIZE_PIXELS);
                    this.context.lineWidth = 1;
                    this.context.strokeStyle = BeerPong.BLOCK_BORDER_COLOR;
                    this.context.strokeRect(left, top, BeerPong.BLOCK_SIZE_PIXELS, BeerPong.BLOCK_SIZE_PIXELS);
                }
            }
        }

        // If there's a falling piece, draw it.
        if (this.snapshot !== null && this.snapshot.hasChild('piece')) {
            var piece = BeerPong.Piece.fromSnapshot(this.snapshot.child('piece'));
            this.drawPiece(piece);
        }
    }

    BeerPong.Board.prototype.drawBall = function () {

    }

    /**
    * Clear the board contents.
    */
    BeerPong.Board.prototype.clear = function () {
        for (var row = 0; row < BeerPong.BOARD_HEIGHT; row++) {
            this.setRow(row, BeerPong.EMPTY_LINE);
        }
    };

    BeerPong.Board.prototype.removeCup = function () {

    }

    BeerPong.Cup.prototype.markCup = function () {

    }

    // BALL
    BeerPong.Ball = function () {
        this.x
        this.theta
        this.power
    }

    BeerPong.Ball.prototype.throwBall = fucntion () {

    }

    BeerPong.Ball.prototype.setX = function () {
        var x = 0;
        var down = false;
        setInterval(function () {
            if (down) {
                x--;
            }
            x++;

            console.log(x);
        }, 16);

        $(document).keypress()
    }

    BeerPong.Ball.prototype.setTheta = function () {

    }

    BeerPong.Ball.prototype.setPower = function () {

    }









    /**
    * Manages joining the game, responding to keypresses, making the piece drop, etc.
    */
    BeerPong.PlayingState = { Watching: 0, Joining: 1, Playing: 2 };

    // CONTROLLER
    BeerPong.Controller = function (beerPongRef) {
        this.beerPongRef = beerPongRef;
        this.createBoard();

        this.playingState = BeerPong.PlayingState.Watching;
        this.waitToJoin();
    };


    BeerPong.Controller.prototype.createBoard = function () {
        for(var i = 0; i <= 1; i++) {
            var playerRef = this.beerPongRef.child('player' + i);
            var canvas = $('#canvas' + i).get(0);
            this.boards.push(new BeerPong.Board(canvas, playerRef));
        }
    };


    BeerPong.Controller.prototype.waitToJoin = function() {
        var self = this;

        // Listen on 'online' location for player0 and player1.
        this.beerPongRef.child('player0/online').on('value', function(onlineSnap) {
            if (onlineSnap.val() === null && self.playingState === BeerPong.PlayingState.Watching) {
                self.tryToJoin(0);
            }
        });

        this.beerPongRef.child('player1/online').on('value', function(onlineSnap) {
            if (onlineSnap.val() === null && self.playingState === BeerPong.PlayingState.Watching) {
                self.tryToJoin(1);
            }
        });
    };


    /**
    * Try to join the game as the specified playerNum.
    */
    BeerPong.Controller.prototype.tryToJoin = function(playerNum) {
    // Set ourselves as joining to make sure we don't try to join as both players. :-)
        this.playingState = BeerPong.PlayingState.Joining;

        // Use a transaction to make sure we don't conflict with other people trying to join.
        var self = this;
        this.beerPongRef.child('player' + playerNum + '/online').transaction(function(onlineVal) {
            if (onlineVal === null) {
                return true; // Try to set online to true.
            } else {
                return; // Somebody must have beat us.  Abort the transaction.
            }
        }, function(error, committed) {
            if (committed) { // We got in!
                self.playingState = BeerPong.PlayingState.Playing;
                self.startPlaying(playerNum);
            } else {
                self.playingState = BeerPong.PlayingState.Watching;
            }
        });
    };


    /**
    * Once we've joined, enable controlling our player.
    */
    BeerPong.Controller.prototype.startPlaying = function (playerNum) {
        this.myPlayerRef = this.beerPongRef.child('player' + playerNum);
        this.opponentPlayerRef = this.beerPongRef.child('player' + (1 - playerNum));
        this.myBoard = this.boards[playerNum];
        this.myBoard.isMyBoard = true;
        this.myBoard.draw();

        // Clear our 'online' status when we disconnect so somebody else can join.
        this.myPlayerRef.child('online').onDisconnect().remove();

        // Detect when game is restarted by other player.
        this.watchForRestart();

        $('#gameInProgress').hide();

        var self = this;
        $('#restartButton').show();
        $("#restartButton").click(function () {
            self.restartGame();
        });

        this.initializePiece();
        this.enableKeyboard();
        this.resetGravity();
    };

    BeerPong.Controller.prototype.watchForRestart = function () {
        var self = this;
        var restartRef = this.myPlayerRef.child('restart');
        restartRef.on('value', function(snap) {
            if (snap.val() === 1) {
                restartRef.set(0);
                self.resetMyBoardAndCups();
            }
        });
    };


    BeerPong.Controller.prototype.gameOver = function () {
        this.restartGame();
    };


    BeerPong.Controller.prototype.restartGame = function () {
        this.opponentPlayerRef.child('restart').set(1);
        this.resetMyBoardAndPiece();
    };


    BeerPong.Controller.prototype.resetMyBoardAndCups = function () {
        this.myBoard.clear();
        var newPiece = new BeerPong.Piece();
        newPiece.writeToFirebase(this.myPlayerRef.child('piece'));
    };



    start();

</script>

</body>
</html>